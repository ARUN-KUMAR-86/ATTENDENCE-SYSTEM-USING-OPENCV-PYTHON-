import cv2
import face_recognition
import os
import pandas as pd
from datetime import datetime

# 1. Load images and names
path = 'dataset'
images = []
student_names = []
image_files = os.listdir(path)

for file in image_files:
    img_path = os.path.join(path, file)
    img = cv2.imread(img_path)
    if img is None:
        print(f"Warning: Could not read image {img_path}. Skipping.")
        continue
    images.append(img)
    student_names.append(os.path.splitext(file)[0])

if not images:
    raise Exception("No valid images found in the dataset folder!")

# 2. Encode faces
def encode_faces(images):
    encode_list = []
    for img in images:
        img_rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
        encodings = face_recognition.face_encodings(img_rgb)
        if encodings:
            encode_list.append(encodings[0])
        else:
            print("Warning: No face found in an image. Skipping.")
    return encode_list

known_encodings = encode_faces(images)

if not known_encodings:
    raise Exception("No faces encoded! Please check the dataset images.")

# 3. Create Excel if not exists
excel_file = 'attendance.xlsx'
if not os.path.exists(excel_file):
    df = pd.DataFrame(columns=['Name', 'Date', 'Time'])
    df.to_excel(excel_file, index=False)

# 4. Mark attendance
def mark_attendance(name):
    df = pd.read_excel(excel_file)
    now = datetime.now()
    date = now.strftime('%Y-%m-%d')
    time = now.strftime('%H:%M:%S')

    # Avoid duplicate attendance on same day
    if not ((df['Name'] == name) & (df['Date'] == date)).any():
        df = pd.concat([df, pd.DataFrame({'Name':[name], 'Date':[date], 'Time':[time]})], ignore_index=True)
        df.to_excel(excel_file, index=False)
        print(f"Attendance marked for {name}")

# 5. Start webcam and recognize faces
cap = cv2.VideoCapture(0)

while True:
    success, frame = cap.read()
    if not success:
        break

    small_frame = cv2.resize(frame, (0,0), fx=0.25, fy=0.25)
    rgb_frame = cv2.cvtColor(small_frame, cv2.COLOR_BGR2RGB)

    faces_in_frame = face_recognition.face_locations(rgb_frame)
    encodings_in_frame = face_recognition.face_encodings(rgb_frame, faces_in_frame)

    for encode_face, face_loc in zip(encodings_in_frame, faces_in_frame):
        matches = face_recognition.compare_faces(known_encodings, encode_face)
        face_distances = face_recognition.face_distance(known_encodings, encode_face)
        best_match_index = face_distances.argmin()

        if matches[best_match_index]:
            name = student_names[best_match_index]
            mark_attendance(name)
            
            # Draw rectangle and name
            y1, x2, y2, x1 = [v*4 for v in face_loc]
            cv2.rectangle(frame, (x1, y1), (x2, y2), (0,255,0), 2)
            cv2.putText(frame, name, (x1, y1-10), cv2.FONT_HERSHEY_SIMPLEX, 0.8, (0,255,0), 2)

    cv2.imshow('Webcam', frame)
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
